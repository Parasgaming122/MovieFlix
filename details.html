<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieFlix - Details</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --netflix-red: #E50914;
            --focus-border: 3px solid #E50914;
        }

        body {
            background-color: #141414;
            color: white;
        }

        .movie-details .backdrop {
            height: 100vh;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        
        .movie-details .overlay {
            background: linear-gradient(to right, rgba(0,0,0,0.9) 20%, rgba(0,0,0,0.6) 80%);
            height: 100%;
            width: 100%;
            padding: 60px;
        }
        
        .movie-details .content {
            max-width: 800px;
            padding-top: 100px;
            position: relative;
        }
        
        .movie-details h1 {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        .movie-details .meta {
            margin-bottom: 20px;
        }
        
        .movie-details .meta span {
            margin-right: 20px;
            color: #ccc;
        }
        
        .movie-details .buttons {
            margin-top: 30px;
        }
        
        .movie-details .buttons .btn {
            margin-right: 15px;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
        }

        .episode-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .episode-item:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
        }

        .seasons-section {
            max-width: 800px;
        }

        #seasonSelect {
            max-width: 200px;
            background-color: #333;
            color: white;
            border: 1px solid #444;
            cursor: pointer;
            position: relative;
        }

        #seasonSelect.active {
            background-color: #444;
        }

        #seasonSelect:focus, #seasonSelect.focused {
            outline: var(--focus-border);
            outline-offset: 2px;
            background-color: #444;
        }

        #seasonSelect option {
            background-color: #333;
            color: white;
            padding: 8px;
        }

        #seasonSelect option:hover {
            background-color: #444;
        }

        #seasonSelect.active option {
            display: block;
        }

        /* Custom dropdown arrow */
        #seasonSelect {
            appearance: none;
            padding-right: 30px;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
        }

        /* Focus styles */
        .btn.focused {
            transform: scale(1.1);
            outline: var(--focus-border);
            outline-offset: 2px;
            z-index: 100;
        }

        .episode-item.focused {
            transform: scale(1.02);
            outline: var(--focus-border);
            outline-offset: 2px;
            z-index: 100;
            background-color: rgba(255, 255, 255, 0.1) !important;
        }

        #seasonSelect.focused {
            outline: var(--focus-border);
            outline-offset: 2px;
        }

        /* Hover styles */
        .btn:hover {
            transform: scale(1.1);
            transition: transform 0.2s;
        }

        .episode-item:hover {
            transform: scale(1.02);
            transition: transform 0.2s;
            background-color: rgba(255, 255, 255, 0.1) !important;
        }

        /* Smooth transitions */
        .btn, .episode-item {
            transition: transform 0.2s, outline 0.2s, background-color 0.2s;
        }

        /* Improve focus visibility */
        .focused {
            position: relative;
            z-index: 100;
        }

        /* Only show focus styles when actually focused/active */
        #seasonSelect:focus {
            outline: none; /* Remove default focus outline */
        }

        #seasonSelect.focused:not(:focus) {
            outline: none;
        }

        #seasonSelect.active, 
        #seasonSelect.focused.active {
            outline: var(--focus-border);
            outline-offset: 2px;
            background-color: #444;
        }

        /* Remove default focus ring */
        #seasonSelect:focus:not(.active) {
            outline: none;
            background-color: #333;
        }

        #seasonSelect option {
            background-color: #333;
            color: white;
            padding: 8px;
        }
    </style>
</head>
<body>
    <div id="content">
        <!-- Content will be populated by JavaScript -->
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        // Constants
        const TMDB_API_KEY = 'fb7bb23f03b6994dafc674c074d01761';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/original';

        // Get movie/show ID and type from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        const type = urlParams.get('type');

        // Fetch and display content when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, ID:', id, 'Type:', type); // Debug log
            if (id && type) {
                loadDetails(id, type);
            } else {
                console.error('Missing ID or type parameters');
                document.getElementById('content').innerHTML = `
                    <div class="alert alert-danger m-4">
                        Error: Missing content parameters
                    </div>
                `;
            }
        });

        let details = null; // Global variable to store current content details

        async function loadDetails(id, type) {
            try {
                console.log('Loading details for:', type, id); // Debug log
                
                // Store in global variable
                details = await fetchFromTMDB(`/${type}/${id}`);
                console.log('Fetched details:', details); // Debug log
                
                // Fetch additional data
                const [credits, videos] = await Promise.all([
                    fetchFromTMDB(`/${type}/${id}/credits`),
                    fetchFromTMDB(`/${type}/${id}/videos`)
                ]);
                
                displayDetails(details, credits, videos, type);
            } catch (error) {
                console.error('Error loading details:', error);
                document.getElementById('content').innerHTML = `
                    <div class="alert alert-danger m-4">
                        Error loading content: ${error.message}
                    </div>
                `;
            }
        }

        function displayDetails(details, credits, videos, type) {
            if (!details || !details.backdrop_path) {
                console.error('Invalid details data:', details);
                return;
            }

            const content = document.getElementById('content');
            const trailer = videos?.results?.find(v => v.type === 'Trailer');
            
            // Format release date or first air date
            const releaseDate = type === 'movie' ? 
                (details.release_date || 'Release date unknown') : 
                `${details.first_air_date || 'First air date unknown'} ${details.number_of_seasons ? `(${details.number_of_seasons} seasons)` : ''}`;
            
            // Create episodes section for TV shows
            const episodesSection = type === 'tv' ? `
                <div class="seasons-section mt-4">
                    <h3>Seasons</h3>
                    <select class="form-select" id="seasonSelect" 
                            data-show-id="${details.id}"
                            onchange="handleSeasonSelect(this)">
                        ${Array.from({length: details.number_of_seasons}, (_, i) => i + 1)
                            .map(num => `<option value="${num}">Season ${num}</option>`)
                            .join('')}
                    </select>
                    <div id="episodesList" class="mt-3"></div>
                </div>
            ` : '';

            const detailsHTML = `
                <div class="movie-details">
                    <div class="backdrop" style="background-image: url('${TMDB_IMAGE_BASE}${details.backdrop_path}')">
                        <div class="overlay">
                            <div class="content">
                                <button class="btn btn-outline-light back-button" onclick="goBack()">
                                    ‚Üê Back
                                </button>
                                <h1>${details.title || details.name}</h1>
                                <div class="meta">
                                    <span>${releaseDate}</span>
                                    <span>${details.vote_average.toFixed(1)}/10</span>
                                </div>
                                <p>${details.overview}</p>
                                <div class="buttons">
                                    <button class="btn btn-danger" onclick="playContent()">
                                        Play
                                    </button>
                                    <button class="btn btn-outline-light" onclick="toggleFavorite(${details.id})">
                                        Add to Favorites
                                    </button>
                                </div>
                                ${episodesSection}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = detailsHTML;

            // Initialize controls after content is loaded
            initializeControls();

            // Load first season episodes for TV shows
            if (type === 'tv') {
                loadEpisodes(details.id, 1);
            }

            // After setting innerHTML, add specific event listeners for season select
            const seasonSelect = document.getElementById('seasonSelect');
            if (seasonSelect) {
                seasonSelect.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape' && this.classList.contains('active')) {
                        event.preventDefault();
                        event.stopPropagation();
                        this.classList.remove('active');
                    }
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(event) {
                    if (!seasonSelect.contains(event.target)) {
                        seasonSelect.classList.remove('active');
                    }
                });

                // Handle dropdown closing after selection
                seasonSelect.addEventListener('change', function() {
                    this.classList.remove('active');
                });
            }
        }

        async function loadEpisodes(showId, seasonNumber) {
            try {
                const seasonDetails = await fetchFromTMDB(`/tv/${showId}/season/${seasonNumber}`);
                const episodesList = document.getElementById('episodesList');
                
                const episodesHTML = seasonDetails.episodes.map(episode => `
                    <div class="episode-item p-2 mb-2 bg-dark rounded" 
                         onclick="playEpisode(${showId}, ${seasonNumber}, ${episode.episode_number})"
                         role="button"
                         tabindex="0">
                        <div class="d-flex align-items-center">
                            <img src="${episode.still_path ? TMDB_IMAGE_BASE + episode.still_path : 'placeholder.jpg'}" 
                                 alt="Episode ${episode.episode_number}"
                                 style="width: 160px; height: 90px; object-fit: cover; margin-right: 15px;">
                            <div>
                                <h5 class="mb-1">Episode ${episode.episode_number}: ${episode.name}</h5>
                                <p class="mb-0 text-muted">${episode.overview.substring(0, 100)}...</p>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                episodesList.innerHTML = episodesHTML;

                // Reinitialize controls after loading episodes
                initializeControls();
            } catch (error) {
                console.error('Error loading episodes:', error);
            }
        }

        function playContent() {
            if (!details) {
                console.error('No details available');
                return;
            }
            window.location.href = `player.html?id=${id}&type=${type}`;
        }

        function playEpisode(showId, season, episode) {
            window.location.href = `player.html?id=${showId}&type=tv&s=${season}&e=${episode}`;
        }

        function toggleFavorite(id) {
            // Implementation for favorites will be added later
            console.log('Toggle favorite:', id);
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        async function fetchFromTMDB(endpoint, params = {}) {
            try {
                const queryParams = new URLSearchParams({
                    api_key: TMDB_API_KEY,
                    ...params
                });
                
                const url = `${TMDB_BASE_URL}${endpoint}?${queryParams}`;
                console.log('Fetching from TMDB:', url); // Debug log
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('TMDB fetch error:', error);
                throw error;
            }
        }

        // Navigation state
        let currentFocus = null;
        let episodeItems = [];

        // Initialize controls
        function initializeControls() {
            // Add keyboard listener
            document.addEventListener('keydown', handleKeyPress);
            
            // Initialize episode items if they exist
            episodeItems = Array.from(document.querySelectorAll('.episode-item'));
            
            // Add mouse hover handlers
            document.querySelectorAll('.btn, .episode-item').forEach(element => {
                element.addEventListener('mouseenter', () => {
                    removeFocus();
                    element.classList.add('focused');
                    currentFocus = element;
                });
            });

            // Set initial focus on play button
            const playButton = document.querySelector('.btn-danger');
            if (playButton) {
                setFocus(playButton);
            }
        }

        // Handle keyboard navigation
        function handleKeyPress(event) {
            switch(event.key) {
                case 'ArrowUp':
                    navigateVertical(-1);
                    break;
                case 'ArrowDown':
                    navigateVertical(1);
                    break;
                case 'ArrowLeft':
                    navigateHorizontal(-1);
                    break;
                case 'ArrowRight':
                    navigateHorizontal(1);
                    break;
                case 'Enter':
                    handleEnter();
                    break;
                case 'Backspace':
                case 'Escape':
                    goBack();
                    break;
            }
        }

        // Vertical navigation
        function navigateVertical(direction) {
            const focusableElements = getFocusableElements();
            if (!focusableElements.length) return;

            let currentIndex = currentFocus ? focusableElements.indexOf(currentFocus) : -1;
            let nextIndex = currentIndex + direction;

            // Handle wrapping
            if (nextIndex < 0) nextIndex = focusableElements.length - 1;
            if (nextIndex >= focusableElements.length) nextIndex = 0;

            setFocus(focusableElements[nextIndex]);
        }

        // Horizontal navigation
        function navigateHorizontal(direction) {
            const focusableElements = getFocusableElements();
            if (!focusableElements.length) return;

            let currentIndex = currentFocus ? focusableElements.indexOf(currentFocus) : -1;
            
            // If in the buttons row, move between buttons
            if (currentFocus && currentFocus.classList.contains('btn')) {
                const buttons = Array.from(document.querySelectorAll('.buttons .btn'));
                let buttonIndex = buttons.indexOf(currentFocus);
                let nextButtonIndex = buttonIndex + direction;
                
                if (nextButtonIndex >= 0 && nextButtonIndex < buttons.length) {
                    setFocus(buttons[nextButtonIndex]);
                    return;
                }
            }

            // Default horizontal navigation
            let nextIndex = currentIndex + direction;
            if (nextIndex >= 0 && nextIndex < focusableElements.length) {
                setFocus(focusableElements[nextIndex]);
            }
        }

        // Handle Enter key
        function handleEnter() {
            if (!currentFocus) return;

            if (currentFocus.id === 'seasonSelect') {
                if (!currentFocus.classList.contains('active')) {
                    // Open the dropdown
                    currentFocus.classList.add('active');
                    currentFocus.click(); // This opens the native select dropdown
                }
            } else {
                currentFocus.click();
            }
        }

        // Update the season select handling
        function handleSeasonSelect(select) {
            const showId = select.dataset.showId;
            const seasonNumber = select.value;
            loadEpisodes(showId, seasonNumber);
        }

        // Get all focusable elements
        function getFocusableElements() {
            const elements = [];
            
            // Add buttons
            elements.push(...document.querySelectorAll('.btn'));
            
            // Add season select if it exists
            const seasonSelect = document.getElementById('seasonSelect');
            if (seasonSelect) elements.push(seasonSelect);
            
            // Add episode items
            elements.push(...document.querySelectorAll('.episode-item'));
            
            return elements;
        }

        // Set focus on element
        function setFocus(element) {
            if (!element) return;
            
            removeFocus();
            element.classList.add('focused');
            currentFocus = element;
            
            // Don't keep focus on season select after selection
            if (element.id === 'seasonSelect' && !element.classList.contains('active')) {
                element.blur(); // Remove browser focus
            }
            
            // Scroll element into view if needed
            element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Remove focus from all elements
        function removeFocus() {
            document.querySelectorAll('.focused').forEach(el => {
                el.classList.remove('focused');
                if (el.id === 'seasonSelect') {
                    el.blur(); // Remove browser focus
                }
            });
            currentFocus = null;
        }
    </script>
</body>
</html> 